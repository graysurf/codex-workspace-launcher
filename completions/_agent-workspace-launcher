#compdef agent-workspace-launcher awl

_agent-workspace-launcher_workspace_names() {
  command agent-workspace-launcher ls 2>/dev/null | awk '{print $1}'
}

_agent-workspace-launcher_completion_mode_is_legacy() {
  [[ "${AGENT_WORKSPACE_COMPLETION_MODE:-}" == "legacy" ]]
}

_agent-workspace-launcher_query_complete() {
  local cword
  local -a command_argv
  local token

  cword="${1:-0}"
  shift

  if (( ! ${+commands[agent-workspace-launcher]} )); then
    return 0
  fi

  command_argv=(
    agent-workspace-launcher
    __complete
    --shell zsh
    --format describe
    --cword "${cword}"
  )
  for token in "$@"; do
    command_argv+=(--word "${token}")
  done

  command "${command_argv[@]}" 2>/dev/null
}

_agent-workspace-launcher_complete_legacy() {
  local cur
  local subcmd
  local candidate
  local -a workspace_names candidates filtered

  cur="${words[CURRENT]:-}"
  subcmd="${words[2]:-}"
  workspace_names=(${(f)"$(_agent-workspace-launcher_workspace_names)"})
  candidates=()
  filtered=()

  if (( CURRENT == 2 )); then
    candidates=(auth create ls rm exec reset tunnel --help --version -h -V)
  else
    case "${subcmd}" in
      auth)
        if (( CURRENT == 3 )); then
          candidates=(github codex gpg --help -h)
        elif (( CURRENT >= 4 )); then
          candidates=("${workspace_names[@]}")
        fi
        ;;
      reset)
        if (( CURRENT == 3 )); then
          candidates=(repo work-repos opt-repos private-repo --help -h)
        elif (( CURRENT == 4 )); then
          candidates=("${workspace_names[@]}")
        fi
        ;;
      rm)
        if (( CURRENT == 3 )); then
          candidates=("${workspace_names[@]}" --all --yes)
        fi
        ;;
      exec|tunnel)
        if (( CURRENT == 3 )); then
          candidates=("${workspace_names[@]}")
        fi
        ;;
    esac
  fi

  for candidate in "${candidates[@]}"; do
    if [[ "${candidate}" == "${cur}"* ]]; then
      filtered+=("${candidate}")
    fi
  done

  if (( ${#filtered[@]} == 0 )); then
    return 1
  fi

  compadd -Q -- "${filtered[@]}"
  return 0
}

_agent-workspace-launcher_complete_modern() {
  local -i cword
  local line value description
  local -a completion_words raw described described_values plain

  cword=$(( CURRENT - 1 ))
  completion_words=("${words[@]}")
  if (( CURRENT > ${#words[@]} )); then
    completion_words+=("")
  fi

  raw=(${(f)"$(_agent-workspace-launcher_query_complete "${cword}" "${completion_words[@]}")"})
  if (( ${#raw[@]} == 0 )); then
    return 1
  fi

  described=()
  described_values=()
  plain=()
  for line in "${raw[@]}"; do
    if [[ "${line}" == *$'\t'* ]]; then
      value="${line%%$'\t'*}"
      description="${line#*$'\t'}"
      described+=("${value}:${description}")
      described_values+=("${value}")
    else
      plain+=("${line}")
    fi
  done

  if (( ${#described[@]} > 0 )); then
    if (( ${+functions[_describe]} )); then
      _describe -t awl-candidates "candidate" described
    else
      compadd -Q -- "${described_values[@]}"
    fi
    if (( ${#plain[@]} > 0 )); then
      compadd -Q -- "${plain[@]}"
    fi
    return 0
  fi

  compadd -Q -- "${plain[@]}"
  return 0
}

_agent-workspace-launcher() {
  if _agent-workspace-launcher_completion_mode_is_legacy; then
    _agent-workspace-launcher_complete_legacy
    return $?
  fi

  _agent-workspace-launcher_complete_modern
}

if (( ${+functions[compdef]} )); then
  compdef _agent-workspace-launcher agent-workspace-launcher awl
fi
